{% extends "basePage.html" %}
{% block content %}
<div class="container">
    <h4>Select a Farm or Metric to filter the sensor table</h2>
    <div class="row">
        <div class="col">
            <label for="farmList" class="form-label">Farm</label>
            <select class="form-select" id="farmList" >
            </select>
        </div>
        <div class="col">
            <label for="metricList" class="form-label">Metric</label>
            <select class="form-select" id="metricList" >
            </select>
        </div>
    </div>
    
</div>
<hr />
<table id="dataTable" class="table table-striped">
    <thead>
      <tr>
        <th>Farm</th>
        <th>DateTime</th>
        <th>Sensor Type</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
{% endblock %}

{% block scripts %}
 <script>
     $(document).ready(function(){
        //Load Farms dropdown lists
        $.ajax({
            url:'/solitafarms/farms/',
            dataType:'json'
        }).done(function(data,_,_){
            farms=data.data
            if (farms.length>0){
               $.each(farms,function(index,item){
                    $("#farmList").append(
                        $('<option></option>').val(item.id).html(item.name)
                    );
               }); 
            }
        });

        //Load metric dropdown lists
        $.ajax({
            url:'/solitafarms/metrics/',
            dataType:'json'
        }).done(function(data,_,_){
            metrics=data.data
            if (metrics.length>0){
               $("#metricList").append(
                    $('<option></option>').val("").html("")
               );
               $.each(metrics,function(index,item){
                    $("#metricList").append(
                        $('<option></option>').val(item.id).html(item.name)
                    );
               }); 
            }
        });

        //Load sensor data table
        table_url='/solitafarms/farms/1/'
        var table=$("#dataTable").DataTable({
            ajax:{
                url:table_url,
                dataSrc:function(json){
                    res=json.data
                    flattened=[]
                    for(i=0;i<res.sensor_data.length;i++){
                            res.sensor_data[i]["farm"]=res.farm.name
                            flattened.push(res.sensor_data[i])
                    }
                    return flattened
                }
            },
            columns:[
                {data:'farm'},
                {data:'date'},
                {data:'metric'},
                {data:'value'}
            ]
        });

        //when farm and metric is selected reload table
        $("#farmList").change(function(){
            if ($("#farmList").val()=="") return
            table_url='/solitafarms/farms/'+$("#farmList").val()+'/'
            console.log(table_url)
            $("#dataTable").DataTable().ajax.reload()
            table.ajax.url(table_url).load()
            
            $("#metricList").val("").change()
        });
        $("#metricList").change(function(){
            if ($("#metricList").val()=="") return;

            table_url='/solitafarms/farms/'+$("#farmList").val()+'/'+'metric/'+$("#metricList").val()+'/'
            console.log(table_url)
            table.ajax.url(table_url).load()
            
        });

        
     });
 </script>
{% endblock %}
